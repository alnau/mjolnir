# mjolnir - программа для анализа профиля лазерного пучка

Изначально программа разрабатывалась для ускорения процесса измерений Малоуглового Рассеяния для стержней Калий Гадолиниевого Вольфрамата (Nd:KGW). Случайным образом 
был реализован интерфейс, а также добавлена возможность измерения клиновидности стержня. В дальнейшем, возможности программы будут расширяться по мере появления новых задач и требований

## Возможности программы:
- Захват изображений с камер DCx/uc480 от ThorLabs, а также с обычных USB камер
- Автоматический поиск направления большой оси пучка и построение распределения интенсивности вдоль него
- Вычисление радиуса, в котором содержится 86.5% интенсивности (радиус гаусова пучка $w(z_{sensor})$)
- Определение клиновидности стержня (угол между нормалями входной и выходной апертур)
- Подготовка отчета

## Алгоритм вычисления направления большой большой оси
Для поиска направления большой оси пучка используется алгоритм дифференциальной эволюции (Differential Evolution) c целевой функцией, возвращающей площадь под кривой интенсивности вдоль 
тестового направления. Программа ищет направление, где эта величина максимальна. Так как данные об интенсивности пучка были получены из изображения с камеры, координаты точек тестовой линии, вдоль которой проводится оптимизация вычисляются с помощью
алгоритма Брэзенхэма. На текущий момент этот метод работает достаточно хорошо, но дает некорректные данные в случае, если наклон тестовой кривой слишком большой. Этот баг будет исправлен
в будущем (надеюсь)

## Алгоритм вычисления радиуса пучка
В качестве критерия качества кристалла с точки зрения степени малоуглового рассеяния использован радиус пучка $w(z_{sensor})$ прямиком из учебника, в предположении, того, что пучок гауссов.
Для начала происходит нормализация изображения и удаление шумовой подложки (зануление яркости пикселей, имеющих интенсивность меньше, чем CUTOFF_THRESHOLD (=5)). 
После этого, находятся координаты $(x_{cm},y_{cm})$ "центра масс" распределения который можно трактовать как центр пучка:

$x_{cm} = \int_\Omega xi(x,y)dxdy$

$y_{cm} = \int_\Omega yi(x,y)dxdy,$

здесь $i(x,y)$ - распределение интенсивности по "сетке" захваченного изображения, $\Omega$ - область изображения. В дальнейших вычислениях эта точка будет считаться центром полярной системы координат.

Далее, в новой системе координат вычисляется интеграл интенсивности по максимально возможному 
радиусу, определяемому как минимальное расстояние до границ изображения:

$I_{max} = \int_0^{r_{max}}\int_0^{2\pi}i(r,\phi)rdrd\phi$ 

В конце концов, радиус 86.5% энергии находится  помощью решения уравнения:

$f(r) = \frac{\int_0^ri_{\phi}(r')r'dr'}{I_{max}} - 0.865 = 0$,

относительно $r$. Здесь:

$i_{\phi}(r) = \int_0^{2\pi}i(r,\phi)d\phi$.

На текущиц момент в программе реализован алгоритм решения этого уравнения методом дихотомии, но ведутся работы по интграции лгоритма на основе метода Ньютона.

### Формулировка метода Ньютона для определения диаметра пучка
Пусть дано уравнение $f(x) = 0$ и требуется найти его корень $x^*$. Можно показать, что для последовательности заданной как:

$x_{n+1} = x_n - \frac{f(x_n)}{f'(x_n)}$

будет выполняться $\lim_{n \to \infty}x_n=x^*$. 

Для нашей задачи довольно легко найти аналитическое выражение для производной функции:

$ \frac{\partial f(r)}{\partial r} =\frac{ri_{\phi}(r)}{I_{max}}  = \frac{r\int_0^{2\pi}i(r,\phi)d\phi}{I_{max}}$, 

т.о итоговое выражение для шага итерации примет вид:

$ r_{n+1} = r_{n} - \frac{\int_0^{r_n}\int_0^{2\pi}i(r,\phi)rdrd\phi - 0.865I_{max}}{r_n\int_0^{2\pi}i(r_n,\phi)d\phi} $

Этот алгоритм все еще требует вычисления одного интеграла по площади на итерацию, но он, в отличие от метода дихотомии, позволяет задать начальное приближение. Учитывая довольно слабую дисперсию реально наблюдаемых радиусов, а также выпуклость интеграла по интенсивности относительно радиуса, можно ожидать куда более быструю сходимость
## Алгоритм вычисления угла клиновидности
Предположим, что нормаль одной из апертур кристалла направлена параллельно оптической оси системы. Тогда в случае отклонения нормали второй грани на угол $\alpha$ от направления 
оптической оси, изображение пучка сместится на $\delta l$ в плоскости матрицы камеры. Вращая стержень вокруг оси, можно найти максимальное отклонение $d_{max}$. Тогда угол можно выразить как:

$\alpha = \frac{\arctan(d_{max}/2L)}{n_{KGW}-1},$

где $L$ - база от кристалла до матрицы, $n_{KGW}$ - показатель преломления KGW
